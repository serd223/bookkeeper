# Quick Start
To see `bookkeeper` in action, you can build the [`dump_people`](https://github.com/serd223/bookkeeper/blob/master/examples/dump_people.c) example:
```console
    $ mkdir build && mkdir gen
    $ make dump
    $ ./build/dump_people
```

# Table of Contents
  * [Overview](https://github.com/serd223/bookkeeper?tab=readme-ov-file#overview)
  * [Using `bookkeeper` in your project](https://github.com/serd223/bookkeeper?tab=readme-ov-file#using-bookkeeper-in-your-project)
  * [Configuration](https://github.com/serd223/bookkeeper?tab=readme-ov-file#configuration)
  * [Schema Extensions](https://github.com/serd223/bookkeeper?tab=readme-ov-file#schema-extensions)
  * [Build Instructions](https://github.com/serd223/bookkeeper?tab=readme-ov-file#build-instructions)

# Overview
`bookkeeper` is a tool inspired by the rust [`serde`](https://serde.rs/) crate and [this stream from Tsoding](https://youtu.be/hnM6aSpWJ8c?si=7WqJW0dy8oaJtdmm).

The `bookkeeper_gen` tool accepts a search path and an output path. It scans the search path for any `.c` or `.h` files and collects all `typedef struct { field_type field; } StructName` style struct definitions inside those files. Each struct can 'derive' functionalities that will be included in the generated code. For instance, if you want your struct to support JSON parsing/dumping you would write:

```c
typedef struct {
    int some_field;
    const char* some_other_field;
} StructName derive_json();
```
(See [people.h](https://github.com/serd223/bookkeeper/blob/master/examples/people.h))

`derive_$schema$` attributes are macroes that are included inside the `derives.h` file generated by `bookkeeper_gen`. So, to use the 'derive' functionality you will need to run `bookkeeper_gen` once to actually acquire the base `derives.h` file that includes the `derive_$schema$` definition. `bookkeeper_gen` generates seperate files for each analyzed file, generated files' names follow the format of `input_file_name.bk.h`, these files are [stb-style header only librarires](https://github.com/nothings/stb?tab=readme-ov-file#faq) that include the implementations of the generated functions for your structs (implementations included with `#define BK_IMPLEMENTATION`). Generated functions look like this:
```c
void dump_$schema$_$type$($type$* item, void* dst) {
    /* generated impl */
}

// returns zero if an error happens, otherwise returns 1
int parse_$schema$_$type$(char* src, unsigned long len, $type$* dst) {
    /* generated impl */
}
```
`bookkeeper` supports user-defined schemas via the schema extension system. See the [Schema Extensions section](https://github.com/serd223/bookkeeper/tree/master?tab=readme-ov-file#schema-extensions) and the [schema extension example](https://github.com/serd223/bookkeeper/blob/master/examples/bookkeeper_gen_ext.c).

Dump functions use a macro named `BK_FMT` defined inside the `*.bk.h` files to output into the provided `dst` buffer. The type of this `dst` argument for the 'dump' family of functions depends on the `BK_FMT_DST_t` macro that you should redefine if your `BK_FMT` implementation expects a different type from the default one. The default implementation uses `fprintf` and expects `dst` to be `FILE*` but it can be redefined inside your code before including your `*.bk.h` file.
(See [dump_people.c](https://github.com/serd223/bookkeeper/blob/master/examples/dump_people.c))

Functions generated for a specific type can be disabled by defining the `BK_DISABLE_$type$` macro in your code.

The names of the special generated macroes mentioned above (like `BK_FMT`) can all be customized via command line arguments supplied to `bookkeeper_gen`. Try `bookkeeper_gen -h` for a list of all available flags.

# Using `bookkeeper` In Your Project
You _can_ just tell people to put the `bookkeeper_gen` executable in their `PATH` while compiling your project but it is probably better to just include the source code of `bookkeeper_gen` in your project and build it during your build process. This is pretty easy since the entire source code of the tool is inside [`bookkeeper_gen.c`](https://github.com/serd223/bookkeeper/blob/master/bookkeeper_gen.c) (This source file also includes its license inside so you don't have to worry about that). The only caveat with this approach is that you also have to include [`stb_c_lexer`](https://github.com/nothings/stb/blob/master/stb_c_lexer.h) in your project but that is a pretty lightweight single file dependency, as well.

You can build `bookkeeper_gen.c` however you like as long as it can find `stb_c_lexer.h`. For instructions on how to build the contents of _this repository_, see the [Build Instructions section](https://github.com/serd223/bookkeeper/tree/master?tab=readme-ov-file#build-instructions).

## Dependencies of generated code
Here is a list of dependencies the **generated code** may depend on:
### parse_json_*
 - These functions depend on the [cJSON](https://github.com/DaveGamble/cJSON) library to parse JSON. Users are expected to have already included this library before including generated code. (See [parse_people.c](https://github.com/serd223/bookkeeper/blob/master/examples/parse_people.c))

# Configuration
The generated code and the behavior of `bookkeeper_gen` can be tweaked using a configuration file or via command line arguments. For a full list of command line options, you can run `bookkeeper_gen -h`.

`bookkeeper_gen` looks for a file named `.bk.conf` in the current working directory by default. This file is optional and parsing a config file is skipped if it doesn't exist. Alternatively, you can supply a custom path for your config file with `bookkeeper_gen --config-path path/to/your/file`. If a custom config path is supplied and that file cannot be found/read, `bookkeeper_gen` reports an error and exits.

A valid config file looks like this:
```
key=value
key1=othervalue
```
Values can be integers, floats, strings, or booleans (denoted with `true` and `false`).

See [full_config.conf](https://github.com/serd223/bookkeeper/blob/master/examples/full_config.conf) for a list of all valid keys.
You can run `bookkeeper_gen -h` to see descriptions that explain what each key means.

# Schema Extensions
In order to add an extension to `bookkeeper`, you will need to wrap the `bookkeeper_gen.c` file in your custom wrapper. You will need the `bookkeeper_gen_ext.h` header to have access to the necessary types in your wrapper. A simple wrapper would look like this:
(See [examples/bookkeeper_gen_ext.c](https://github.com/serd223/bookkeeper/blob/master/examples/bookkeeper_gen_ext.c) for a full example)
```c
    #include "bookkeper_gen_ext.h"
    // Common includes you probably will need in extensions
    #include <stdio.h>
    #include <stdlib.h>
    #include <string.h>

    size_t gen_example_dump_decl(String* book_buf, CCompound* ty, const char* dst_type) { /* impl */ }
    size_t gen_example_parse_decl(String* book_buf, CCompound* ty) { /* impl */ }
    void gen_example_dump_impl(String* book_buf, CCompound* ty, const char* dst_type, const char* fmt_macro) { /* impl */ }
    void gen_example_parse_impl(String* book_buf, CCompound* ty) { /* impl */ }

    #define BK_ADD_SCHEMAS(s)\
    Schema example = {\
        .gen_dump_decl = gen_example_dump_decl,\
        .gen_parse_decl = gen_example_parse_decl,\
        .gen_dump_impl = gen_example_dump_impl,\
        .gen_parse_impl = gen_example_parse_impl,\
        .derive_attr = "derive_example"\
    };\
    push_da(&s, example);
    // This file should be able to find `stb_c_lexer.h` since it is included by `bookkeeper_gen.c`
    #include "bookkeeper_gen.c"
```

In order to test the provided extension example, you can run:
```console
    $ make schema_ext
    $ ./build/bookkeeper_gen_ext -d ./examples -od ./gen
```
You can then inspect the generated files inside the `gen` folder to see the generated example schema functions.

# Build Instructions
## Prerequisites
 - [clang](https://releases.llvm.org/download.html)
 - [git](https://git-scm.com/)

## Instructions
First, you will need to clone this repository and `cd` into the repository's root directory:
```console
    $ git clone https://github.com/serd223/bookkeeper.git
    $ cd bookkeeper
```

Then create `build` and `gen` folders:
```console
    $ mkdir build
    $ mkdir gen
```

You can build `bookkeeper_gen` by running:
```console
    $ make
```

## Building Examples
If you want to build the `dump_people` example, run: (auto-generates necessary files)
```console
    $ make dump
    $ ./build/dump_people
```

If you want to build the `parse_people` example, run: (auto-generates necessary files)
```console
    $ make parse
    $ ./build/parse_people
```

