# Overview
`bookkeeper` is a tool inspired by the rust [`serde`](https://serde.rs/) crate and [this stream from Tsoding](https://youtu.be/hnM6aSpWJ8c?si=7WqJW0dy8oaJtdmm).

# Usage
The `bookkeeper_gen` tool accepts an optional search path (defaults to '.') and optional flags. It scans the search path for any `.c` or `.h` files and collects all `typedef struct { field_type field; } StructName` style struct definitions inside those files. Each struct can 'derive' functionalities that will be included in the generated code. For instance, if you want your struct to support JSON parsing/dumping you would write:

```c
typedef struct {
    int some_field;
    const char* some_other_field;
} StructName derive_json();
```
(See [people.h](https://github.com/serd223/bookkeeper/blob/master/examples/people.h))

Note that you can use the optional `--derive-all` flag while invoking `bookkeeper_gen` to derive all possible derives for every struct.

`derive_$schema$` attributes are macroes that are included inside the `bookkeeper.h` file generated by `bookkeeper_gen`. So, to use the 'derive' functionality you will need to run `bookkeeper_gen` once to actually acquire the base `bookkeeper.h` file that includes the `derive_$schema$` definition. `bookkeeper_gen` also generates a file named `bookkeeper.c` which contains the implementations of the generated parsing/dumping functions for your structs. Generated functions look like this:
```c
void dump_$schema$_$type$($type$* item, void* dst) {
    /* generated impl */
}

// returns zero if an error happens, otherwise returns 1
int parse_$schema$_$type$(char* src, unsigned long len, $type$* dst) {
    /* generated impl */
}
```
Dump functions use a macro named `BK_FMT` defined inside `bookkeeper.c` to output into the provided `dst` buffer. The `void* dst` that is accepted through the `dump` family of functions is directly passed to `BK_FMT` so the underlying type of `dst` depends on your `BK_FMT` implementation. The default implementation uses `sprintf` and expects `dst` to be `char*` but it can be redefined inside your code before including `bookkeeper.c`.
(See [dump_people.c](https://github.com/serd223/bookkeeper/blob/master/examples/dump_people.c))

# Dependencies
Here is a list of dependencies the **generated code** may depend on:
## parse_json
 - These functions depend on the [cJSON](https://github.com/DaveGamble/cJSON) library to parse JSON. Users are expected to have already included this library before including generated code. (See [parse_people.c](https://github.com/serd223/bookkeeper/blob/master/examples/parse_people.c))

# Build Instructions
## Prerequisites
    - [clang](https://releases.llvm.org/download.html)
    - [git](https://git-scm.com/)

## Instructions
First, you will need to clone this repository and `cd` into the repository's root directory:
```console
    $ git clone https://github.com/serd223/bookkeeper.git
    $ cd bookkeeper
```

Then create `build` and `gen` folders:
```console
    $ mkdir build
    $ mkdir gen
```

You can build `bookkeeper_gen` by running:
```console
    $ make
```

## Building examples
If you want to build the `dump_people` example, run: (auto-generates necessary files)
```console
    $ make dump
    $ ./build/dump_people
```

If you want to build the `parse_people` example, run: (auto-generates necessary files)
```console
    $ make parse
    $ ./build/parse_people
```

